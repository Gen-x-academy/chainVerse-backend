const express = require('express');
const certificateController = require('../controllers/certificateController');
const auth = require('../middlewares/auth');
const {
	validateCertificateQuery,
	validateCertificateId,
	handleValidationErrors,
	sanitizeQueryParams,
} = require('../validators/certificateRetrievalValidator');

const router = express.Router();

// Specific routes - must come before dynamic :certificateId routes
router.get(
	'/my-certificates/download-all',
	auth.authenticate,
	certificateController.downloadAllCertificates
);

router.get(
	'/my-certificates',
	auth.authenticate,
	sanitizeQueryParams,
	validateCertificateQuery,
	handleValidationErrors,
	certificateController.getMyCertificates
);

router.get(
	'/download/:certificateId',
	validateCertificateId,
	handleValidationErrors,
	certificateController.downloadSingleCertificate
);

// Public routes - no authentication required
router.get('/public/:publicHash', certificateController.getPublicCertificate);

// Dynamic routes with :certificateId - must come after specific routes
router.get(
	'/:certificateId/verify-ownership',
	auth.authenticate,
	validateCertificateId,
	handleValidationErrors,
	certificateController.verifyCertificateOwnershipEndpoint
);

router.get(
	'/:certificateId/public-link',
	auth.authenticate,
	certificateController.generatePublicLink
);

router.get(
	'/:certificateId/share-metadata',
	auth.authenticate,
	certificateController.getShareMetadata
);

router.post(
	'/:certificateId/track-share',
	auth.authenticate,
	certificateController.trackShare
);

router.get(
	'/:certificateId',
	auth.authenticate,
	validateCertificateId,
	handleValidationErrors,
	certificateController.getSingleCertificate
);

module.exports = router;
